<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Implementation</title>
    <link href="../style/langref.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <h1>Implementation</h1>

    <h2 id="is-and-as-expressions">Is and As Expressions</h2>

    <p>
        The implementation of <b>is</b> and <b>as</b> expressions is based on a scheme invented by Michael Gibbs and Bjarne Stroustrup
        and described in their article <a href="http://www.stroustrup.com/fast_dynamic_casting.pdf">Fast dynamic casting</a>.
    </p>

    <p>
        Each polymorphic class in Cmajor has a unique 64-bit identifier that is a product of prime number keys.
        The prime number key of the class is based on the level of the class in the class hierarchy.
        Ultimate base classes are assigned keys 2, 3, 5, etc., and the leaf classes of the class hierarchy have the largest keys.
        The identifier of a class is the product of the key of itself, the key of its base class, the key of its ancestor class, and so on.
    </p>

    <p>
        When we have these class identifiers, the test whether a polymorphic class A is the same class or derived from the class B
        becomes a simple modulo operation: <em>classIdOf(A) % classIdOf(B) == 0</em> <=> A is same or derived from B.
    </p>

    <p>
        The 64-bit identifier of a class is stored to the virtual method table of the class at index 0. 
        The addresses of the virtual method table are exported from the executable so that the runtime initialization
        function can find out their memory addresses.
    </p>
    <p>
        When the program starts executing it calls the RtInit function of the Cmajor runtime library cmrt200.dll
        that reads class hierarchy information of the polymorphic classes from the <em>program.cls</em> file, 
        computes the key and 64-bit class identifier for each class, finds out the virtual method table address of each class 
        and stores the class identifier there.
    </p>
</body>